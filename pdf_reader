import re
from pdfminer.high_level import extract_pages, extract_text
import geonamescache
import pycountry
import pypdf
import openpyxl 
from openpyxl import load_workbook
from openpyxl.styles import Alignment

gc = geonamescache.GeonamesCache()
cities = gc.get_cities()
state_list = list(pycountry.countries) 
city_names = set(city['name'] for city in cities.values())

"""for page_layout in extract_pages("invoice.pdf"):
    for element in page_layout:
        print(element)"""
        
text = extract_text("invoice_3.pdf")


delivery = text.find("Delivery")
end = text.find("Payment")

delivery_adress = text[delivery:end-1]

incoterm_list = ["EXW","FOB","FCA","CFR","CPT","CIF","CIP","DAP","DDP"]

def incoterm_overlook(incoterm_list):
    for i in incoterm_list:
        found = int(text.find(i))
        if found != -1:
            if i == "DDP" and text[found+4] == "V":
                return "DDP VAT Unpaid"
            else:
                return i

def find_city(delivery_adress):
    tokenized = delivery_adress.split()
    if "Asahi" in tokenized:
        tokenized.remove("Asahi")
    for i in tokenized:
        if gc.get_cities_by_name(i):
            return i
    
    

def find_state_code():
    tokenized = delivery_adress.split()
    for i in tokenized:
        if i in [country.alpha_2 for country in pycountry.countries]:
            return i 
            
    




founded_inco = incoterm_overlook(incoterm_list)
founded_city = find_city(delivery_adress)
founded_state = find_state_code()
"""delivery_note = done
invoice_num = done
netto = done
zb = done
quant = done
description = done
"""
print(text)
print(founded_inco)
print(founded_city)
print(founded_state)




pdf_reader = pypdf.PdfReader("invoice_3.pdf")



# Get the number of pages in the PDF file
num_pages = len(pdf_reader.pages)

# Loop over each page in the PDF file
def print_pages():
    for page_num in range(num_pages):
        # Get the page object for the current page
        page = pdf_reader.pages[page_num]

        # Extract the text content from the page
        page_text = page.extract_text()

        # Print the text content to the console
        if page_text.find("PRODUCTS") == -1:
            table_start = page_text.find("GOODS")
        else:
            table_start = page_text.find("PRODUCTS")
        table_end = page_text.find("OTHERS")
        table = page_text[table_start:table_end]
        return table,page_text
    

# najít ZB podle ZB klíče a produkt bude vždy za netto váhou .. hledat dle ,(0-9)(0-9)

# Define the regular expression patterns
zb_pattern = r"ZB\w+"
quant_pattern = r"pc\s*\d{1,3}(?:\s+\d{3})*" # matches zero or more groups of one or more whitespace characters followed by exactly three digits.
desc_pattern = r"%\s*\d{1,3}(?:\s+\d{3})*" # This pattern matches a percentage sign followed by a space, and then 1 to 5 digits, a comma, and 2 more digits. It can be used to match strings like "% 465,12".
netto_pattern = r"%\s*\d{1,3}(?:\s+\d{3})*,\d{2}" # + ,00
inv_pattern = r"\d{2}03\w+"  
dl_pattern = r"\d{2}(?:SL|MH)01\w+"
order_pattern = r"\d{2}[A-Z0-9]{4}0\d{9}INVOICE"

  
table,page_text = print_pages()

print(table)
# Find all matches of the code pattern in the input string
codes = re.findall(zb_pattern, table)
quantity_list = re.findall(quant_pattern, table)
quantity_list = [quantity.replace('pc', '').replace('\xa0', '').strip() for quantity in quantity_list]
description = re.findall(desc_pattern, table)
#description = [desc.replace("\xa0"," ").strip() for desc in description] # this will remove \xa0 from the string but it will not find it afterwards
netto = re.findall(netto_pattern,table)
netto = [net.replace("%","").replace('\xa0', '') for net in netto]


def inv_lookup(what_to_look_for, text):
    findings = re.findall(what_to_look_for, text)
    return findings

invoice = re.search(inv_pattern, page_text)
invoice = invoice.group(0)

dl_note = inv_lookup(dl_pattern,page_text)
order_num = inv_lookup(order_pattern, page_text)
order_num = [order.replace("INVOICE","") for order in order_num]

def last_element(table, pattern):
    row_table = table.split('\n')
    end_list = []
    for row in row_table:
        if re.search(pattern, row):
            end = row.split()[-1]
            end_list.append(end)
    return end_list, row_table

end_list,row_table = last_element(table,zb_pattern)

# Print the results
print("Codes: ", codes)
print("Quantity: ", quantity_list)
#print("Start Product description: ", description)
print("Netto list is: ", netto)
print("End list : ",end_list)  
print("Invoice number is: ", invoice)
print("Delivery note number is:", dl_note)
print("Order number is: ", order_num)

for start, end in zip(netto, end_list):
    start_pos = table.find(start) + len(start) + 1
    end_pos = table.find(end, start_pos) # finds the index of the first occurrence of end after the start substring.
    print(table[start_pos:end_pos + 2])


print("\n\n\n")
#print(page_text)



workbook = load_workbook("PL_blank.xlsx")
ws = workbook["List1"]

delivery_adress = delivery_adress.replace("Delivery adress:","")
adress_cell = ws["B9"]
adress_cell.alignment = Alignment(horizontal='left', wrap_text=True)
adress_cell.value = delivery_adress


PL_cell = ws["A5"]
#PL_cell.alignment = Alignment(horizontal='center', wrap_text=True)
PL_cell.value = "PACKING LIST - " + ", ".join(dl_note)


INV_cell = ws["A7"]
#INV_cell.alignment = Alignment(horizontal='center', wrap_text=True)
INV_cell.value = "INVOICE: " + invoice



workbook.save(f"PL {dl_note[0]} {founded_city} {founded_state}.xlsx")
print("PL was saved and exported")
